window.DropDown=function(a){"use strict";if(!(this instanceof window.DropDown))return new window.DropDown(a);var b={},c={},d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=null,m=!1,n=navigator.userAgent.match(/iPhone|iPod|iPad/gi),o={id:null,name:"",fieldName:"name",fieldId:"id",defaultText:"",emptyText:"",menuAlign:"left",cls:"",menuCls:"",iconCls:"",showSidebar:!1,multiselect:!1,action:null,value:null,defaultValue:null,additionalOptions:null,items:[],url:null,params:{},isStatic:!1,disabled:!1},p=function(){if(m){q();var a=g.find(".menu-items"),b=c.offset(),d={left:b.left,top:b.top,width:c.width(),height:c.height()},e={height:$(window).innerHeight(),scrollTop:$(window).scrollTop()},f={left:d.left,top:d.top+d.height,width:g.outerWidth(),minHeight:100,margin:20};g.height("auto").removeClass("menu-top"),a.height("auto"),f.height=f.autoHeight=g.height(),"right"===o.menuAlign&&(f.left-=f.width-d.width),f.top+f.height+f.margin>e.height+e.scrollTop&&(f.height=e.height-f.top-f.margin+e.scrollTop,f.height<f.minHeight&&(f.height=f.minHeight)),f.top+f.height+f.margin>e.height+e.scrollTop&&(g.addClass("menu-top"),f.height=f.autoHeight,f.height>d.top-e.scrollTop-f.margin&&(f.height=d.top-e.scrollTop-f.margin,f.height<f.minHeight&&(f.height=f.minHeight)),f.top=d.top-f.height-2),g.css({left:f.left,top:f.top,height:f.height}),f.height-=parseInt(a.css("paddingTop"),10)+parseInt(a.css("paddingBottom"),10),g.find(".menu-filter").length&&(f.height-=g.find(".menu-filter").outerHeight()),g.find(".menu-select").length&&(f.height-=g.find(".menu-select").outerHeight()),g.find(".menu-apply").length&&(f.height-=g.find(".menu-apply").outerHeight()),a.height(f.height),l=null}},q=function(){var a,b=g.find(".has-sidebar"),c=20,d=0,e=null,f=20;if(b.length){for(a=b.find(".menu-item-aside").width("auto");e=a[d++];)c=Math.max(c,$(e).outerWidth());f=parseInt(a.closest(".menu-item").css("padding-left"),10),g.find(".has-sidebar").css("padding-left",c),a.outerWidth(c).css("margin-left",-(c+f))}},r=function(a){if(!m)return C();l||(l={items:g.find(".menu-item:visible"),mn:g.find(".menu-items")[0]});var b=l.items,c=l.mn,e=null;if(a=a||0,b&&b.length){i&&i.length||(i=b.first().addClass("focused"));var f=i,h=b.index(f[0]),j=h+a,k=b.eq(j);0>a?0===h?k=null:(0>j&&(k=b.first()),e=k[0].offsetTop,c.scrollTop<=e&&(e=null)):a>0&&(k&&k.length||(k=b.last()),e=k[0].offsetTop+k[0].offsetHeight-c.offsetHeight,c.scrollTop>=e&&(e=null)),k&&k.length?(d.focus(),null!==e&&(c.scrollTop=e),f.removeClass("focused"),i=k.addClass("focused")):(c.scrollTop=0,g.find(".menu-filter-text").focus())}},s=function(a,b){if("function"==typeof a)a=a.call(b);else{var c=/\{(\w+)\}/i.exec(a);if(c&&c.length)for(;c&&c.length>1;)a=a.replace(c[0],b[c[1]]||""),c=/\{(\w+)\}/i.exec(a);else a="array"===$.type(b)?b[0]:"object"===$.type(b)?b[a]:b}return a},t=function(a,b){var c,d=a.toLowerCase(),e=0,f=-1;for(b=b.toLowerCase();c=b[e++];)if(!~(f=d.indexOf(c,f+1)))return!1;return!0},u=function(a){if(!o.disabled&&!c.hasClass("dropdown-disabled")){var d,f,h;if(h="keydown"===a.type?i:$(a.target),h&&(h.closest(".menu-item").length&&(h=h.closest(".menu-item")),d=h.data("id"),void 0!==d)){if(o.multiselect!==!0)return f=h.data("name"),D(a),H(d,f),void(o.action&&o.action.call(o.scope||o.action,d,j,b));a.preventDefault();var l,m,n=h.hasClass("menu-item-checked");if("#apply"===d){if(h.closest(".no-items-selected").length)return;return O(),D(a),void(o.action&&o.action.call(o.scope||o.action,K(),k,b))}if("#select-all"===d?(l=n,n?A():y()):h.closest(".menu-select").length?h.toggleClass("menu-item-checked",!n):g.hasClass("all-items-selected")?(z(),h.removeClass("menu-item-checked"),m=g.find(".menu-items .menu-item-checked"),0===m.length&&(e.html("No "+o.defaultText),g.removeClass("all-items-selected multiple-items-selected").addClass("no-items-selected")),l=0===m.length):(g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"),h.toggleClass("menu-item-checked",!n),m=g.find(".menu-items .menu-item-checked"),1===m.length?e.html(m.data("name")||m.data("id")):0===m.length?(e.html("No "+o.defaultText),g.removeClass("all-items-selected multiple-items-selected").addClass("no-items-selected")):e.html("Multiple "+o.defaultText),l=0===m.length),g.find(".menu-apply").length||l||!o.action)o.action||O();else{g.append(Z()),p();var q=h.closest(".menu-items"),r=q.innerHeight(),s=h.position().top,t=h.outerHeight(!0)+s;0>=s&&q.scrollTop(-s),t>r&&q.scrollTop(t-r)}g.find(".menu-items .menu-item").length===g.find(".menu-items .menu-item-checked").length&&y()}}},v=function(){c.removeClass("dropdown-disabled"),c.find("input").prop("disabled",!1),o.disabled=!1},w=function(){c.addClass("dropdown-disabled"),c.find("input").prop("disabled",!0),o.disabled=!0},x=function(a){if("keyup"!==a.type||a.keyCode&&27===a.keyCode){var b=$(a.target);b.parents(".menu").length||b.hasClass("menu")||D()}},y=function(){g.find(".menu-items .menu-item-checked,.menu-item-all.menu-item-checked").removeClass("menu-item-checked"),g.find(".menu-item-all").addClass("menu-item-checked"),g.removeClass("multiple-items-selected no-items-selected").addClass("all-items-selected"),e.html("All "+o.defaultText)},z=function(){g.find(".menu-item-all").removeClass("menu-item-checked"),g.find(".menu-items .menu-item").addClass("menu-item-checked"),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"),e.html("Multiple "+o.defaultText)},A=function(){g.find(".menu-items .menu-item,.menu-item-all").removeClass("menu-item-checked"),g.removeClass("all-items-selected multiple-items-selected").addClass("no-items-selected"),e.html("No "+o.defaultText)},B=function(a){m?D(a):C()},C=function(){if(!o.disabled&&!m){E();var a=g.find(".menu-items"),d=a.find(".menu-item");return g.css("min-width",c.width()),a.length&&d.length||(g.html('<ul><li class="loading">Please wait...</li></ul>'),o.items&&o.items.length?S(o.items):o.url&&o.url.length?P():T()),c.addClass("expanded"),m=!0,g.show(),p(),setTimeout(function(){$(document).on("mousedown touchstart keyup",x),$(window).one("resize",x),n||g.find(".menu-filter-text").focus()},10),n||g.find(".menu-filter-text").focus(),b}},D=function(a){return m?(a&&a.stopPropagation(),g.hide(),g.find(".menu-apply").remove(),c.removeClass("expanded"),m=!1,R(),d.focus(),$(document).off("mousedown DOMMouseScroll mousewheel keyup",x),$(window).off("resize",x),b):b},E=function(){$(".dropdown.expanded").each(function(a,b){b=$(b).data("dropdown"),b&&b.collapse&&b.collapse()})},F=function(){return j=i=null,g.find(".selected,.focused").removeClass("selected focused"),o.defaultValue?H(o.defaultValue):o.multiselect===!0?H([],"All "+(o.defaultText||"items")):o.defaultText&&o.defaultText.length?H("",o.defaultText):o.emptyText&&o.emptyText.length&&!o.isStatic?H("",o.emptyText):H(),b},G=function(){return o.items=[],g.find(".menu-items .menu-item").remove(),b},H=function(a,c){if(o.multiselect===!0)return I(a,c);if(o.value=a,(void 0===a||null===a)&&(a=""),f.val(a),j=i=null,g.find(".selected,.focused").removeClass("selected focused"),""!==a&&o.items&&o.items.length){if(i=g.find(".menu-item-id-"+_(a)),i.length){o.isStatic||i.addClass("selected focused");for(var d,h=0;d=o.items[h++];)if(a==("object"==typeof d?d[o.fieldId]:d)){j=d;break}}!c&&j?c=s(o.fieldName,j):c||(c=a),o.isStatic||e.html(c)}else c=c||(""===a?o.defaultText||"":a),o.isStatic||e.html(c);return b},I=function(a,c){if(void 0!==a&&null!==a&&""!==a){if("array"!==$.type(a)&&(a=[a]),o.value=a,a.length){var d,f=g.find(".menu-items .menu-item"),h=0,i=a.length;if(0===i)A();else if(e.html("Multiple "+o.defaultText),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"),f.length)if(f.length===i)y();else{for(A();i>h;h++)f.filter(".menu-item-id-"+_(a[h])).addClass("menu-item-checked");d=f.filter(".menu-item-checked"),1===d.length?e.html(d.data("name")):0===d.length?A():(e.html("Multiple "+o.defaultText),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"))}else e.html(c&&c.length?c:"Multiple "+o.defaultText),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected")}else y();return b}},J=function(a){var c=g.find(".menu-items .menu-item").eq(a||0);return c.length&&H(c.data("id"),c.data("name")),b},K=function(){return o.value},L=function(){return f.val()},M=function(){return e.text()},N=function(){var a={},b=g.find(".menu-select .menu-item-additional-option");return b.each(function(c,d){d=b.eq(c),a[d.data("id")]=d.hasClass("menu-item-checked")}),a},O=function(){var a,b=g.hasClass("all-items-selected"),c=g.find(".menu-items .menu-item-checked"),d=[],e=0;if(!b)for(;a=c[e++];)d.push($(a).data("id"));o.value=d},P=function(){o.url&&$.ajax({url:o.url,type:"get",dataType:"json",data:o.params}).fail(function(){U()}).done(function(a){a&&"error"!==a.result?S(a):U()})},Q=function(a){var b,c,d=g.find(".menu-filter"),e=d.find(".menu-filter-text"),f=g.find(".menu-items"),h=f.find(".menu-item"),i=0;if(g.find(".no-results").remove(),d.length){for("string"!=typeof a&&(a=e.val()),e.val(a),d.toggleClass("menu-filter-dirty",!!a.length);b=h[i++];)b=$(b),c=b.data("group")+b.data("name"),t(c,a)?b.show():b.hide();h.not(".menu-header").filter(":visible").each(function(){$(this).prevAll(".menu-header:first").show()}),m&&!h.filter(":visible").length&&f.append('<li class="no-results">No items found!</li>'),e.focus(),p(),l=null}},R=function(){Q("")},S=function(a){if(g.html(""),a&&a.length){var c,d,f=[],h=o.fieldName,i=o.fieldId,j=o.showSidebar?" has-sidebar":"";if(a.length>10&&g.append(V()),o.multiselect===!0?g.append('<ul class="menu-select'+j+'">'+X(null,"Select All")+Y()+"</ul>"):o.defaultText&&o.defaultText.length&&f.push(X("",o.defaultText)),"function"==typeof h||"string"==typeof h&&h.indexOf("{")>-1)for(c=0;d=a[c++];)f.push(X(d[i],s(h,d),d));else if("object"!=typeof a[0])for(c=0;d=a[c++];)f.push(X(d,d,d));else for(c=0;d=a[c++];)f.push(X(d[i],d[h],d));f.length&&g.append('<ul class="menu-items'+j+'">'+f.join("")+"</ul>"),o.items=a||[]}else T();if(!o.items||!o.items.length)return b;var k=L()||K();return"undefined"!=typeof k&&null!==k&&""!==k&&k!==[]?H(k):o.defaultValue?H(o.defaultValue):o.emptyText&&o.emptyText.length&&!o.isStatic?e.html(o.emptyText):F(),p(),n||g.find(".menu-filter-text").focus(),l=null,b},T=function(){g.html('<span class="loading-error">No items</span>')},U=function(){g.html('<span class="loading-error">Loading error</span>')},V=function(){var a=o.showSidebar?" has-sidebar":"",b='<div class="menu-filter'+a+'"><div class="menu-filter-inner">';return o.showSidebar&&(b+='<span class="menu-item-aside">Search</span>'),b+='<span class="search-icon"></span>',b+='<input type="text" class="menu-filter-text"/>',b+="</div></div>"},W=function(a){var b=a.iconCls&&a.iconCls.length,c="";return c='<a class="button'+(b?" icon-button":"")+'" href="#">',c+='<span class="expander"></span>',b&&(c+='<span class="icon '+a.iconCls+'"></span>'),c+='<input type="hidden" name="'+a.name+'" />',c+='<span class="text">'+(a.emptyText.length?a.emptyText:"")+"</span>",c+="</a>",c+=a.showSidebar===!0?'<div class="menu menu-with-sidebar"></div>':'<div class="menu"></div>'},X=function(a,b,c){var d="",e="",f=[],g="";return"object"==typeof c?(c.cls&&c.cls.length&&f.push(c.cls),c.isHeader===!0&&f.push("menu-header"),c.group&&(g=c.group,c.sidebarText=g),(c.sidebarText||c.sidebarCls)&&(e='<span class="menu-item-aside '+(c.sidebarCls||"")+'">'+(c.sidebarText||"")+"</span>")):c={},f.push(b===o.defaultText?"menu-item-empty-text":"menu-item-id-"+_(a)),(o.multiselect===!0&&c.checked!==!1||c.checked===!0)&&f.push("menu-item-checked"),o.multiselect===!0&&null===a&&(f.push("menu-item-all"),a="#select-all"),d+='<li class="menu-item '+f.join(" ")+'" data-id="'+a+'" data-name="'+b+'" data-group="'+g+'">',d+=e,o.multiselect===!0&&(d+='<span class="menu-item-tick"></span>'),d+='<span class="menu-item-name">'+b+"</span>",d+="</li>"},Y=function(){if(!o.additionalOptions||!o.additionalOptions.length)return"";for(var a,b=0,c=[];a=o.additionalOptions[b++];)a.cls="menu-item-additional-option",c.push(X(a.id,a.name,a));return c.join("")},Z=function(){return'<ul class="menu-apply'+(o.showSidebar?" has-sidebar":"")+'"><li class="menu-item" data-id="#apply"><span class="menu-item-tick"></span><span class="menu-item-name">Apply</span></li></ul>'},_=function(a){return(""+a).replace(/[^\w\d\-]/g,"")},ab=function(){"string"==typeof o.target&&(o.target="#"+o.target),c=$(o.target),h=c.clone();var a,b=[];if(c.is("input")?(a=c[0],o.name=a.name,!o.id&&a.id&&(o.id=a.id),!o.value&&c.val()&&(o.value=c.val()),c=$("<div>").replaceAll(c)):c.is("select")&&(a=c[0],o.name=a.name,o.value=a.value||null,!o.id&&a.id&&(o.id=a.id),b=[],c.find("option").each(function(){b.push({id:this.value,name:this.innerHTML})}),o.items=b,c=$("<div>").replaceAll(c)),c.addClass("dropdown "+o.cls).html(W(o)),d=c.find(".button"),g=c.find(".menu").appendTo("body"),e=c.find(".text"),f=c.find("input[type=hidden]").val(""),o.multiselect===!0&&(o.isStatic=!0,c.addClass("static"),g.addClass("multiselect"),o.value&&o.value.length&&"string"==typeof o.value)){var i=o.value.split(",");i.length&&H(i)}if("undefined"!=typeof o.id&&c.attr("id",o.id),o.menuCls&&g.addClass(o.menuCls),o.disabled&&w(),o.items&&o.items.length&&S(o.items),o.defaultText&&o.defaultText.length&&!o.isStatic&&e.html(o.defaultText),o.emptyText&&o.emptyText.length&&e.html(o.emptyText),o.defaultValue&&H(o.defaultValue),void 0!==o.value&&null!==o.value){var j=o.value[o.fieldId],k=o.value[o.fieldName];"object"===$.type(o.value)&&j&&k?H(j,k):H(o.value)}else(o.url||!o.items)&&F()},bb=function(){c.on({mousedown:function(a){B(a)},click:function(){return!1},focus:function(){d.addClass("focused")},blur:function(){d.removeClass("focused")},keydown:function(a){switch(a.keyCode){case 32:case 13:u(a);break;case 9:D();break;case 27:D(a);break;case 38:a.preventDefault(),r(-1);break;case 40:a.preventDefault(),r(1);break;case 33:a.preventDefault(),r(-10);break;case 34:a.preventDefault(),r(10)}}},".button"),g.on({mousedown:function(){return!1},mouseup:function(a){return u(a),!1},click:function(){n&&setTimeout(function(){$(window).scrollTop(200)},0)}},"ul").on("focus",".menu-filter-text",function(){i=null,g.find(".focused").removeClass("focused")}).on("keydown",".menu-filter-text",function(a){27!==a.keyCode||this.value.length?(40===a.keyCode||34===a.keyCode)&&(a.preventDefault(),r()):D()}).on("keyup change",".menu-filter-text",function(a){27===a.keyCode&&this.value.length&&(this.value=""),Q(this.value)}).on("click",".menu-filter .search-icon",R).on("mouseover","li",function(){g.find(".focused").removeClass("focused"),i=$(this).addClass("focused")}),c.one("destroyed",cb)},cb=function(){c&&c.length&&(D(),g&&g.length&&g.remove(),h&&h.length&&(o.isStatic||!h.is("input")&&!h.is("select")||h.val(L()),h.insertAfter(c)),c.remove())},db=function(a){var d;return"string"==typeof a.target?(d=$("#"+a.target),d.is(".dropdown")&&d.data("dropdown").destroy()):"object"==typeof a.target&&a.target.hasClass("dropdown")&&a.target.data("dropdown").destroy(),o=$.extend(!0,{},o,a),ab(),bb(),c.data("dropdown",b),b};return b={getEl:function(){return c},label:function(){return e},button:function(){return d},menu:function(){return g},getItems:function(){return o.items},setItems:S,getSelectedItem:function(){return j},replaceList:S,getConfig:function(){return o},setConfig:function(a){return $.extend(o,a||{}),b},getValue:K,setValue:H,getIdValue:L,getCaption:M,getAdditionalOptions:N,select:J,reset:F,clearList:G,show:function(){return c.show(),b},hide:function(){return c.hide(),b},isEnabled:function(){return!c.hasClass("dropdown-disabled")},enable:v,disable:w,isExpanded:function(){return m},expand:C,collapse:D,destroy:cb},db(a)};