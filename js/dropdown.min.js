window.DropDown=function(a){"use strict";if(!(this instanceof window.DropDown))return new window.DropDown(a);var b={},c={},d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=null,m={},n=!1,o=navigator.userAgent.match(/iPhone|iPod|iPad/gi),p={id:null,name:"",fieldName:"name",fieldId:"id",emptyText:"",defaultText:"",menuAlign:"left",cls:"",menuCls:"",iconCls:"",showSidebar:!1,multiselect:!1,action:null,value:null,defaultValue:null,allowNone:!1,multiselectLabels:{all:"All ",none:"No ",multi:"Multiple "},additionalOptions:null,items:[],url:null,params:{},isStatic:!1,disabled:!1},q=function(){if(n){r();var a=g.find(".menu-items"),b=c.offset(),d={left:b.left,top:b.top,width:c.width(),height:c.height()},e={height:$(window).innerHeight(),scrollTop:$(window).scrollTop()},f={left:d.left,top:d.top+d.height,width:g.outerWidth(),minHeight:100,margin:20};g.height("auto").removeClass("menu-top"),a.height("auto"),f.height=f.autoHeight=g.height(),"right"===p.menuAlign&&(f.left-=f.width-d.width),f.top+f.height+f.margin>e.height+e.scrollTop&&(f.height=e.height-f.top-f.margin+e.scrollTop,f.height<f.minHeight&&(f.height=f.minHeight)),f.top+f.height+f.margin>e.height+e.scrollTop&&(g.addClass("menu-top"),f.height=f.autoHeight,f.height>d.top-e.scrollTop-f.margin&&(f.height=d.top-e.scrollTop-f.margin,f.height<f.minHeight&&(f.height=f.minHeight)),f.top=d.top-f.height-2),g.css({left:f.left,top:f.top,height:f.height}),f.height-=parseInt(a.css("paddingTop"),10)+parseInt(a.css("paddingBottom"),10),g.find(".menu-filter").length&&(f.height-=g.find(".menu-filter").outerHeight()),g.find(".menu-select").length&&(f.height-=g.find(".menu-select").outerHeight()),g.find(".menu-apply").length&&(f.height-=g.find(".menu-apply").outerHeight()),a.height(f.height),l=null}},r=function(){var a,b=g.find(".has-sidebar"),c=20,d=0,e=null,f=20;if(b.length){for(a=b.find(".menu-item-aside").width("auto");e=a[d++];)c=Math.max(c,$(e).outerWidth());f=parseInt(a.closest(".menu-item").css("padding-left"),10),g.find(".has-sidebar").css("padding-left",c),a.outerWidth(c).css("margin-left",-(c+f))}},s=function(a){if(!n)return E();l||(l={items:g.find(".menu-item:visible"),mn:g.find(".menu-items")[0]});var b=l.items,c=l.mn,e=null;if(a=a||0,b&&b.length){i&&i.length||(i=b.first().addClass("focused"));var f=i,h=b.index(f[0]),j=h+a,k=b.eq(j);0>a?0===h?k=null:(0>j&&(k=b.first()),e=k[0].offsetTop,c.scrollTop<=e&&(e=null)):a>0&&(k&&k.length||(k=b.last()),e=k[0].offsetTop+k[0].offsetHeight-c.offsetHeight,c.scrollTop>=e&&(e=null)),k&&k.length?(d.focus(),null!==e&&(c.scrollTop=e),f.removeClass("focused"),i=k.addClass("focused")):(c.scrollTop=0,g.find(".menu-filter-text").focus())}},t=function(a,b){if("function"==typeof a)a=a.call(b);else{var c=/\{(\w+)\}/i.exec(a);if(c&&c.length)for(;c&&c.length>1;)a=a.replace(c[0],b[c[1]]||""),c=/\{(\w+)\}/i.exec(a);else a="array"===$.type(b)?b[0]:"object"===$.type(b)?b[a]:b}return a},u=function(){if(m={},!p.additionalOptions||!p.additionalOptions.length)return b;for(var a,c=0;a=p.additionalOptions[c++];)m[a.id]=a.checked;return b},v=function(a,b){var c,d=a.toLowerCase(),e=0,f=-1;for(b=b.toLowerCase();c=b[e++];)if(!~(f=d.indexOf(c,f+1)))return!1;return!0},w=function(a){if(!p.disabled&&!c.hasClass("dropdown-disabled")){var d,h,l;if(l="keydown"===a.type?i:$(a.target),l&&(l.closest(".menu-item").length&&(l=l.closest(".menu-item")),d=l.data("id"),void 0!==d)){if(p.multiselect!==!0)return h=l.data("name"),F(a),J(d,h),p.action&&p.action.call(p.scope||p.action,d,j,b),void f.trigger("change");a.preventDefault();var n,o,r=l.hasClass("menu-item-checked");if("#apply"===d){if(l.closest(".no-items-selected").length)return;return Q(),F(a),void(p.action&&p.action.call(p.scope||p.action,M(),k,b))}if("#select-all"===d?(n=r,r?C():A()):l.closest(".menu-select").length?(l.toggleClass("menu-item-checked",!r),m[d]=!r):g.hasClass("all-items-selected")?(B(),l.removeClass("menu-item-checked"),o=g.find(".menu-items .menu-item-checked"),0===o.length&&(e.html(p.multiselectLabels.none+p.defaultText),g.removeClass("all-items-selected multiple-items-selected").addClass("no-items-selected")),n=0===o.length):(g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"),l.toggleClass("menu-item-checked",!r),o=g.find(".menu-items .menu-item-checked"),1===o.length?e.html(o.data("name")||o.data("id")):0===o.length?(e.html(p.multiselectLabels.none+p.defaultText),g.removeClass("all-items-selected multiple-items-selected").addClass("no-items-selected")):e.html(p.multiselectLabels.multi+p.defaultText),n=0===o.length),g.find(".menu-apply").length||n||!p.action)p.action||Q();else{g.append(ab()),q();var s=l.closest(".menu-items"),t=s.innerHeight(),u=l.position().top,v=l.outerHeight(!0)+u;0>=u&&s.scrollTop(-u),v>t&&s.scrollTop(v-t)}g.find(".menu-items .menu-item").length===g.find(".menu-items .menu-item-checked").length&&A()}}},x=function(){c.removeClass("dropdown-disabled"),c.find("input").prop("disabled",!1),p.disabled=!1},y=function(){c.addClass("dropdown-disabled"),c.find("input").prop("disabled",!0),p.disabled=!0},z=function(a){if("keyup"!==a.type||a.keyCode&&27===a.keyCode){var b=$(a.target);b.parents(".menu").length||b.hasClass("menu")||F()}},A=function(){g.find(".menu-items .menu-item-checked,.menu-item-all.menu-item-checked").removeClass("menu-item-checked"),g.find(".menu-item-all").addClass("menu-item-checked"),g.removeClass("multiple-items-selected no-items-selected").addClass("all-items-selected"),e.html(p.multiselectLabels.all+p.defaultText)},B=function(){g.find(".menu-item-all").removeClass("menu-item-checked"),g.find(".menu-items .menu-item").addClass("menu-item-checked"),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"),e.html(p.multiselectLabels.multi+p.defaultText)},C=function(){g.find(".menu-items .menu-item,.menu-item-all").removeClass("menu-item-checked"),g.removeClass("all-items-selected multiple-items-selected").addClass("no-items-selected"),e.html(p.multiselectLabels.none+p.defaultText)},D=function(a){n?F(a):E()},E=function(){if(!p.disabled&&!n){G();var a=g.find(".menu-items"),d=a.find(".menu-item");return g.css("min-width",c.width()),a.length&&d.length||(g.html('<ul><li class="loading">Please wait...</li></ul>'),p.items&&p.items.length?U(p.items):p.url&&p.url.length?R():V()),c.addClass("expanded"),n=!0,g.show(),q(),setTimeout(function(){$(document).on("mousedown touchstart keyup",z),$(window).one("resize",z),o||g.find(".menu-filter-text").focus()},10),o||g.find(".menu-filter-text").focus(),b}},F=function(a){return n?(a&&a.stopPropagation(),g.hide(),g.find(".menu-apply").remove(),c.removeClass("expanded"),n=!1,T(),d.focus(),$(document).off("mousedown DOMMouseScroll mousewheel keyup",z),$(window).off("resize",z),b):b},G=function(){$(".dropdown.expanded").each(function(a,b){b=$(b).data("dropdown"),b&&b.collapse&&b.collapse()})},H=function(){return j=i=null,g.find(".selected,.focused").removeClass("selected focused"),null!==p.defaultValue?J(p.defaultValue):p.multiselect===!0?J([],p.multiselectLabels.all+(p.defaultText||"items")):p.defaultText&&p.defaultText.length?J("",p.defaultText):p.emptyText&&p.emptyText.length&&!p.isStatic?J("",p.emptyText):J(),u(),P(),b},I=function(){return p.items=[],g.find(".menu-items .menu-item").remove(),b},J=function(a,c){if(p.multiselect===!0)return K(a,c);if(p.value=a,(void 0===a||null===a)&&(a=""),f.val(a),j=i=null,g.find(".selected,.focused").removeClass("selected focused"),""!==a&&p.items&&p.items.length){if(i=g.find(".menu-item-id-"+bb(a)),i.length){p.isStatic||i.addClass("selected focused");for(var d,h=0;d=p.items[h++];)if(a==("object"==typeof d?d[p.fieldId]:d)){j=d;break}}!c&&j?c=t(p.fieldName,j):c||(c=a),p.isStatic||e.html(c)}else c=c||(""===a?p.defaultText||"":a),p.isStatic||e.html(c);return b},K=function(a,c){if(void 0!==a&&null!==a&&""!==a){if("array"!==$.type(a)&&(a=[a]),p.value=a,a.length){var d,f=g.find(".menu-items .menu-item"),h=0,i=a.length;if(0===i)C();else if(e.html(p.multiselectLabels.multi+p.defaultText),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"),f.length)if(f.length===i)A();else{for(C();i>h;h++)f.filter(".menu-item-id-"+bb(a[h])).addClass("menu-item-checked");d=f.filter(".menu-item-checked"),1===d.length?e.html(d.data("name")):0===d.length?C():(e.html(p.multiselectLabels.multi+p.defaultText),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected"))}else e.html(c&&c.length?c:p.multiselectLabels.multi+p.defaultText),g.removeClass("all-items-selected no-items-selected").addClass("multiple-items-selected")}else p.allowNone?C():A();return b}},L=function(a){var c=g.find(".menu-items .menu-item").eq(a||0);return c.length&&J(c.data("id"),c.data("name")),b},M=function(){return p.value},N=function(){return f.val()},O=function(){return e.text()},P=function(a){if(p.additionalOptions&&p.additionalOptions.length){var c,d=g.find(".menu-select .menu-item-additional-option"),e=0;if("object"==typeof a)for(;c=p.additionalOptions[e++];)m[c.id]=a[c.id];return d.each(function(a,b){b=d.eq(a),"undefined"!=typeof m[b.data("id")]&&b.toggleClass("menu-item-checked",m[b.data("id")]===!0)}),b}},Q=function(){var a,b=g.hasClass("all-items-selected"),c=g.find(".menu-items .menu-item-checked"),d=[],e=0;if(!b)for(;a=c[e++];)d.push($(a).data("id"));p.value=d},R=function(){p.url&&$.ajax({url:p.url,type:"post",dataType:"json",data:p.params}).fail(function(){W()}).done(function(a){a&&"error"!==a.result?U(a):W()})},S=function(a){var b,c,d=g.find(".menu-filter"),e=d.find(".menu-filter-text"),f=g.find(".menu-items"),h=f.find(".menu-item"),i=0;if(g.find(".no-results").remove(),d.length){for("string"!=typeof a&&(a=e.val()),e.val(a),d.toggleClass("menu-filter-dirty",!!a.length);b=h[i++];)b=$(b),c=b.data("group")+b.data("name"),v(c,a)?b.show():b.hide();h.not(".menu-header").filter(":visible").each(function(){$(this).prevAll(".menu-header:first").show()}),n&&!h.filter(":visible").length&&f.append('<li class="no-results">No items found!</li>'),e.focus(),q(),l=null}},T=function(){S("")},U=function(a){if(g.html(""),a&&a.length){var c,d,f=[],h=p.fieldName,i=p.fieldId,j=p.showSidebar?" has-sidebar":"";if(a.length>10&&g.append(X()),p.multiselect===!0?g.append('<ul class="menu-select'+j+'">'+Z(null,"Select All")+_()+"</ul>"):p.defaultText&&p.defaultText.length&&f.push(Z("",p.defaultText)),"function"==typeof h||"string"==typeof h&&h.indexOf("{")>-1)for(c=0;d=a[c++];)f.push(Z(d[i],t(h,d),d));else if("object"!=typeof a[0])for(c=0;d=a[c++];)f.push(Z(d,d,d));else for(c=0;d=a[c++];)f.push(Z(d[i],d[h],d));f.length&&g.append('<ul class="menu-items'+j+'">'+f.join("")+"</ul>"),p.items=a||[]}else V();if(!p.items||!p.items.length)return b;var k=N()||M();return"undefined"!=typeof k&&null!==k&&""!==k&&k!==[]?J(k):null!==p.defaultValue?J(p.defaultValue):p.emptyText&&p.emptyText.length&&!p.isStatic?e.html(p.emptyText):H(),q(),o||g.find(".menu-filter-text").focus(),l=null,b},V=function(){g.html('<span class="loading-error">No items</span>')},W=function(){g.html('<span class="loading-error">Loading error</span>')},X=function(){var a=p.showSidebar?" has-sidebar":"",b='<div class="menu-filter'+a+'"><div class="menu-filter-inner">';return p.showSidebar&&(b+='<span class="menu-item-aside">Search</span>'),b+='<span class="search-icon"></span>',b+='<input type="text" class="menu-filter-text"/>',b+="</div></div>"},Y=function(a){var b=a.iconCls&&a.iconCls.length,c="";return c='<a class="button'+(b?" icon-button":"")+'" href="#">',c+='<span class="expander"></span>',b&&(c+='<span class="icon '+a.iconCls+'"></span>'),c+='<input type="hidden" name="'+a.name+'" />',c+='<span class="text">'+(a.emptyText.length?a.emptyText:"")+"</span>",c+="</a>",c+=a.showSidebar===!0?'<div class="menu menu-with-sidebar"></div>':'<div class="menu"></div>'},Z=function(a,b,c){var d="",e="",f=[],g="";return"object"==typeof c?(c.cls&&c.cls.length&&f.push(c.cls),c.isHeader===!0&&f.push("menu-header"),c.group&&(g=c.group,c.sidebarText=g),(c.sidebarText||c.sidebarCls)&&(e='<span class="menu-item-aside '+(c.sidebarCls||"")+'">'+(c.sidebarText||"")+"</span>")):c={},f.push(b===p.defaultText?"menu-item-empty-text":"menu-item-id-"+bb(a)),(p.multiselect===!0&&c.checked!==!1||c.checked===!0)&&f.push("menu-item-checked"),p.multiselect===!0&&null===a&&(f.push("menu-item-all"),a="#select-all"),d+='<li class="menu-item '+f.join(" ")+'" data-id="'+a+'" data-name="'+b+'" data-group="'+g+'">',d+=e,p.multiselect===!0&&(d+='<span class="menu-item-tick"></span>'),d+='<span class="menu-item-name">'+b+"</span>",d+="</li>"},_=function(){if(!p.additionalOptions||!p.additionalOptions.length)return"";for(var a,b,c=0,d=[];a=p.additionalOptions[c++];)b={checked:m[a.id],cls:"menu-item-additional-option"},d.push(Z(a.id,a.name,b));return d.join("")},ab=function(){return'<ul class="menu-apply'+(p.showSidebar?" has-sidebar":"")+'"><li class="menu-item" data-id="#apply"><span class="menu-item-tick"></span><span class="menu-item-name">Apply</span></li></ul>'},bb=function(a){return(""+a).replace(/[^\w\d\-]/g,"")},cb=function(){"string"==typeof p.target&&(p.target="#"+p.target),c=$(p.target),h=c.clone();var a,b=[];if(c.is("input")?(a=c[0],p.name=a.name,!p.id&&a.id&&(p.id=a.id),!p.value&&c.val()&&(p.value=c.val()),c=$("<div>").replaceAll(c)):c.is("select")&&(a=c[0],p.name=a.name,p.value=a.value||null,!p.id&&a.id&&(p.id=a.id),b=[],c.find("option").each(function(){b.push({id:this.value,name:this.innerHTML})}),p.items=b,c=$("<div>").replaceAll(c)),c.addClass("dropdown "+p.cls).html(Y(p)),d=c.find(".button"),g=c.find(".menu").appendTo("body"),e=c.find(".text"),f=c.find("input[type=hidden]").val(""),p.multiselect===!0&&(p.isStatic=!0,c.addClass("static"),g.addClass("multiselect"),p.value&&p.value.length&&"string"==typeof p.value)){var i=p.value.split(",");i.length&&J(i)}if(u(),"undefined"!=typeof p.id&&c.attr("id",p.id),p.menuCls&&g.addClass(p.menuCls),p.disabled&&y(),p.items&&p.items.length&&U(p.items),p.defaultText&&p.defaultText.length&&!p.isStatic&&e.html(p.defaultText),p.emptyText&&p.emptyText.length&&e.html(p.emptyText),null!==p.defaultValue&&J(p.defaultValue),void 0!==p.value&&null!==p.value){var j=p.value[p.fieldId],k=p.value[p.fieldName];"object"===$.type(p.value)&&j&&k?J(j,k):J(p.value)}else(p.url||!p.items)&&H()},db=function(){c.on({mousedown:function(a){D(a)},click:function(){return!1},focus:function(){d.addClass("focused")},blur:function(){d.removeClass("focused")},keydown:function(a){switch(a.keyCode){case 32:w(a);break;case 9:F();break;case 27:F(a);break;case 38:a.preventDefault(),s(-1);break;case 13:n?w(a):s(1);break;case 40:a.preventDefault(),s(1);break;case 33:a.preventDefault(),s(-10);break;case 34:a.preventDefault(),s(10)}}},".button"),g.on({mousedown:function(){return!1},mouseup:function(a){return w(a),!1},click:function(){o&&setTimeout(function(){$(window).scrollTop(200)},0)}},"ul").on("focus",".menu-filter-text",function(){i=null,g.find(".focused").removeClass("focused")}).on("keydown",".menu-filter-text",function(a){27!==a.keyCode||this.value.length?(40===a.keyCode||34===a.keyCode)&&(a.preventDefault(),s()):F()}).on("keyup change",".menu-filter-text",function(a){27===a.keyCode&&this.value.length&&(this.value=""),S(this.value)}).on("click",".menu-filter .search-icon",T).on("mouseover","li",function(){g.find(".focused").removeClass("focused"),i=$(this).addClass("focused")}),c.one("destroyed",eb)},eb=function(){c&&c.length&&(F(),g&&g.length&&g.remove(),h&&h.length&&(p.isStatic||!h.is("input")&&!h.is("select")||h.val(N()),h.insertAfter(c)),c.remove())},fb=function(a){var d;return"string"==typeof a.target?(d=$("#"+a.target),d.is(".dropdown")&&d.data("dropdown").destroy()):"object"==typeof a.target&&a.target.hasClass("dropdown")&&a.target.data("dropdown").destroy(),p=$.extend(!0,{},p,a),cb(),db(),c.data("dropdown",b),b};return b={getEl:function(){return c},label:function(){return e},button:function(){return d},menu:function(){return g},getItems:function(){return p.items},setItems:U,getSelectedItem:function(){return j},replaceList:U,getConfig:function(){return p},setConfig:function(a){return $.extend(p,a||{}),b},getValue:M,setValue:J,getIdValue:N,getCaption:O,getAdditionalOptions:function(){return m},setAdditionalOptions:P,select:L,reset:H,clearList:I,show:function(){return c.show(),b},hide:function(){return c.hide(),b},isEnabled:function(){return!c.hasClass("dropdown-disabled")},enable:x,disable:y,isExpanded:function(){return n},expand:E,collapse:F,destroy:eb},fb(a)};